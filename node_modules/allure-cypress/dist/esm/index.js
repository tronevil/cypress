var u=function(e){return e.FAILED="failed",e.BROKEN="broken",e.PASSED="passed",e.SKIPPED="skipped",e}({}),Ge=[u.FAILED,u.BROKEN,u.PASSED,u.SKIPPED],Be=function(e){return e.SCHEDULED="scheduled",e.RUNNING="running",e.FINISHED="finished",e.PENDING="pending",e.INTERRUPTED="interrupted",e}({}),l=function(e){return e.ALLURE_ID="ALLURE_ID",e.AS_ID="ALLURE_ID",e.SUITE="suite",e.PARENT_SUITE="parentSuite",e.SUB_SUITE="subSuite",e.EPIC="epic",e.FEATURE="feature",e.STORY="story",e.SEVERITY="severity",e.TAG="tag",e.OWNER="owner",e.LEAD="lead",e.HOST="host",e.THREAD="thread",e.TEST_METHOD="testMethod",e.TEST_CLASS="testClass",e.PACKAGE="package",e.FRAMEWORK="framework",e.LANGUAGE="language",e.LAYER="layer",e}({}),Ve=function(e){return e.BLOCKER="blocker",e.CRITICAL="critical",e.NORMAL="normal",e.MINOR="minor",e.TRIVIAL="trivial",e}({}),w=function(e){return e.TEXT="text/plain",e.XML="application/xml",e.HTML="text/html",e.CSV="text/csv",e.TSV="text/tab-separated-values",e.CSS="text/css",e.URI="text/uri-list",e.SVG="image/svg+xml",e.PNG="image/png",e.JSON="application/json",e.ZIP="application/zip",e.WEBM="video/webm",e.JPEG="image/jpeg",e.MP4="video/mp4",e.IMAGEDIFF="application/vnd.allure.image.diff",e}({}),R=function(e){return e.DEFAULT="link",e.ISSUE="issue",e.TMS="tms",e}({});function P(){P=function(a,o){return new r(a,void 0,o)};var e=RegExp.prototype,t=new WeakMap;function r(n,a,o){var i=RegExp(n,a);return t.set(i,o||t.get(n)),D(i,r.prototype)}function s(n,a){var o=t.get(a);return Object.keys(o).reduce(function(i,p){var g=o[p];if(typeof g=="number")i[p]=n[g];else{for(var f=0;n[g[f]]===void 0&&f+1<g.length;)f++;i[p]=n[g[f]]}return i},Object.create(null))}return Ke(r,RegExp),r.prototype.exec=function(n){var a=e.exec.call(this,n);if(a){a.groups=s(a,this);var o=a.indices;o&&(o.groups=s(o,this))}return a},r.prototype[Symbol.replace]=function(n,a){if(typeof a=="string"){var o=t.get(this);return e[Symbol.replace].call(this,n,a.replace(/\$<([^>]+)>/g,function(p,g){var f=o[g];return"$"+(Array.isArray(f)?f.join("$"):f)}))}if(typeof a=="function"){var i=this;return e[Symbol.replace].call(this,n,function(){var p=arguments;return typeof p[p.length-1]!="object"&&(p=[].slice.call(p)).push(s(p,i)),a.apply(this,p)})}return e[Symbol.replace].call(this,n,a)},P.apply(this,arguments)}function Ke(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&D(e,t)}function D(e,t){return D=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,s){return r.__proto__=s,r},D(e,t)}var v=e=>{switch(!0){case/assert/gi.test(e.constructor.name):case/expectation/gi.test(e.constructor.name):case/assert/gi.test(e.name):case/assert/gi.test(e.message):case(e.stack&&/@vitest\/expect/gi.test(e.stack)):case(e.stack&&/playwright\/lib\/matchers\/expect\.js/gi.test(e.stack)):case"matcherResult"in e:return u.FAILED;default:return u.BROKEN}},ze=function(){var{onlyFirst:t=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},r=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(r,t?void 0:"g")},I=e=>{var t=ze();return e.replace(t,"")},S=e=>{var{message:t,stack:r}=e;return{message:t?I(t):void 0,trace:r?I(r):void 0}},te=P(/(?:^|\s)@?allure\.id[:=]([^\s]+)/,{id:1}),$e=new RegExp(te,"g"),re=P(/(?:^|\s)@?allure\.label\.([^:=\s]+)[:=]([^\s]+)/,{name:1,value:2}),We=new RegExp(re,"g");var F=e=>{var t=[];e.split(" ").forEach(s=>{var n,a=(n=s.match(te))===null||n===void 0||(n=n.groups)===null||n===void 0?void 0:n.id;a&&t.push({name:l.ALLURE_ID,value:a});var o=s.match(re),{name:i,value:p}=o?.groups||{};i&&p&&t?.push({name:i,value:p})});var r=e.replace(We,"").replace($e,"").trim();return{labels:t,cleanTitle:r}};var Ye=e=>e.reduce((t,r)=>{if(r.type!=="step_start"&&r.type!=="step_stop")return t;if(r.type==="step_start")return t.push([r]),t;var s=t.findLastIndex(n=>n.length===1);return s===-1||t[s].push(r),t},[]),O=e=>{var t=Ye(e);return t.filter(r=>r.length===1)},x=e=>!!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function",H=function(t){var{maxDepth:r=0,maxLength:s=0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Xe(typeof t=="object"?JSON.stringify(t,qe(r)):String(t),s)},qe=e=>{var t=[];return function(r,s){if(typeof s!="object"||s===null)return s;for(;t.length>0&&!Object.is(t.at(-1),this);)t.pop();if(!(e&&t.length>=e||t.includes(s)))return t.push(s),s instanceof Map?Ze(t,s):s instanceof Set?Je(t,s):s}},Ze=(e,t)=>Array.from(t).filter(r=>{var[s]=r;return!e.includes(s)}).map(r=>{var[s,n]=r;return[s,e.includes(n)?void 0:n]}),Je=(e,t)=>Array.from(t).map(r=>e.includes(r)?void 0:r),Xe=(e,t)=>t&&e.length>t?"".concat(e.substring(0,t),"..."):e;var E="__allure_report_system_hook__",_="__allure_report_step_command__";function se(e,t,r,s,n,a,o){try{var i=e[a](o),p=i.value}catch(g){return void r(g)}i.done?t(p):Promise.resolve(p).then(s,n)}function m(e){return function(){var t=this,r=arguments;return new Promise(function(s,n){var a=e.apply(t,r);function o(p){se(a,s,n,o,i,"next",p)}function i(p){se(a,s,n,o,i,"throw",p)}o(void 0)})}}var N=class{attachment(){var t=this;return m(function*(){yield t.warning()})()}attachmentFromPath(){var t=this;return m(function*(){yield t.warning()})()}description(){var t=this;return m(function*(){yield t.warning()})()}descriptionHtml(){var t=this;return m(function*(){yield t.warning()})()}displayName(){var t=this;return m(function*(){yield t.warning()})()}historyId(){var t=this;return m(function*(){yield t.warning()})()}labels(){var t=this;return m(function*(){yield t.warning()})()}links(){var t=this;return m(function*(){yield t.warning()})()}parameter(){var t=this;return m(function*(){yield t.warning()})()}logStep(){var t=this;return m(function*(){yield t.warning()})()}step(t,r){var s=this;return m(function*(){return yield s.warning(),r()})()}stepDisplayName(){var t=this;return m(function*(){yield t.warning()})()}stepParameter(){var t=this;return m(function*(){yield t.warning()})()}testCaseId(){var t=this;return m(function*(){yield t.warning()})()}warning(){return m(function*(){console.log("no test runtime is found. Please check test framework configuration")})()}},T=new N;var ne="allureTestRuntime",j=e=>{globalThis[ne]=()=>e},L=()=>globalThis?.[ne],U=()=>{var e=L();if(e){var t;return(t=e())!==null&&t!==void 0?t:T}return T},G=()=>{var e=L();if(e){var t;return(t=e())!==null&&t!==void 0?t:T}if("_playwrightInstance"in globalThis)try{return(0,eval)("(() => import('allure-playwright/autoconfig'))()").then(()=>{var r,s;return(r=(s=L())===null||s===void 0?void 0:s())!==null&&r!==void 0?r:T})}catch(r){return console.log("can't execute allure-playwright/autoconfig",r),T}return T};var d=function(t){for(var r=arguments.length,s=new Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];var a=G();return x(a)?a.then(o=>o[t](...s)):a[t](...s)},y=(e,t)=>d("labels",{name:e,value:t}),Qe=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("labels",...r)},B=(e,t,r)=>d("links",{url:e,type:r,name:t}),et=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("links",...r)},tt=(e,t,r)=>d("parameter",e,t,r),rt=e=>d("description",e),st=e=>d("descriptionHtml",e),nt=e=>d("displayName",e),at=e=>d("historyId",e),ot=e=>d("testCaseId",e),it=(e,t,r)=>{var s=typeof r=="string"?{contentType:r}:r;return d("attachment",e,t,s)},pt=(e,t,r)=>{var s=typeof r=="string"?{contentType:r}:r;return d("attachmentFromPath",e,t,s)},ut=()=>({displayName:e=>d("stepDisplayName",e),parameter:(e,t,r)=>d("stepParameter",e,t,r)}),lt=(e,t,r)=>d("logStep",e,t,r),ct=(e,t)=>d("step",e,()=>t(ut())),dt=(e,t)=>B(e,t,R.ISSUE),mt=(e,t)=>B(e,t,R.TMS),yt=e=>y(l.ALLURE_ID,e),gt=e=>y(l.EPIC,e),ft=e=>y(l.FEATURE,e),ht=e=>y(l.STORY,e),St=e=>y(l.SUITE,e),vt=e=>y(l.PARENT_SUITE,e),Tt=e=>y(l.SUB_SUITE,e),Ct=e=>y(l.OWNER,e),xt=e=>y(l.SEVERITY,e),Et=e=>y(l.LAYER,e),_t=e=>y(l.TAG,e),At=function(){for(var t=arguments.length,r=new Array(t),s=0;s<t;s++)r[s]=arguments[s];return d("labels",...r.map(n=>({name:l.TAG,value:n})))};var ae={stepsFromCommands:{maxArgumentLength:128,maxArgumentDepth:3}},oe=e=>Array.isArray(e)||e.buffer?btoa(String.fromCharCode.apply(null,e)):e,ie=e=>{let t=[];for(let r=e.parent;r;r=r.parent)t.push(r);return t.reverse(),t};var V=e=>Mt(e.attributes.args)?.log===!1||e.attributes.name==="task"&&e.attributes.args[0]==="reportAllureRuntimeMessages"||e.attributes.name==="then"||e.attributes.name==="wrap"&&e.attributes.args[0]===_;var Mt=e=>e[e.length-1],Rt=e=>{let t=fe(),r=t?e.absolute.substring(t.length+1):e.relative;return Cypress.platform==="win32"?r.replaceAll("\\","/"):r},pe=(e,t)=>{let r=t.title,{cleanTitle:s,labels:n}=F(r),o=`${[...t.titlePath().slice(0,-1),s].join(" ")}`;return{name:s,labels:n,fullNameSuffix:o}},K=e=>({...pe(Cypress.spec,e),start:e.wallClockStartedAt?.getTime()||Date.now()}),ue=e=>({duration:e.duration??0,retries:e._retries??0}),z=()=>({statusDetails:{message:"This is a pending test"}}),le=(e,t)=>{let r=ge();if(r){let s=Rt(e);for(let n of de(t)){let a=Dt(r,e,s,n.tests);kt(n.tests,a)}}};var ce=Symbol("The test was reported to Allure"),$=e=>{e[ce]=!0},A=e=>e[ce]===!0,de=function*(e){let t=[];for(let r=e;r;r=t.pop()){yield r;for(let s=r.suites.length-1;s>=0;s--)t.push(r.suites[s])}},me=function*(e){for(let t of de(e))yield*t.tests},C=e=>e.title.includes(E),ye=e=>e.parent.root&&e.hookName==="after all",Pt=(e,t,r)=>e.tests.some(s=>r&&s.id?.toString()===r||s.selector===t),Dt=(e,t,r,s)=>{let n=[];return s.forEach((a,o)=>{let{fullNameSuffix:i,labels:p}=pe(t,a),g=`${r}#${i}`,f=p.find(({name:Ue})=>Ue===l.ALLURE_ID)?.value;Pt(e,g,f)||n.push(o)}),n},kt=(e,t)=>{for(let r=t.length-1;r>=0;r--)e.splice(t[r],1)};var h=()=>{let e=Cypress.env("allure");return e||(e={config:ae,initialized:!1,messages:[],testPlan:void 0,currentTest:void 0,projectDir:void 0},Cypress.env("allure",e)),e},he=()=>h().initialized,Se=()=>{h().initialized=!0},b=()=>h().messages,ve=e=>{h().messages=e},c=e=>{b().push(e)},ge=()=>h().testPlan,fe=()=>h().projectDir,Te=()=>h().currentTest,Ce=e=>{h().currentTest=e},xe=()=>{h().currentTest=void 0},Ee=()=>h().config;var W=class{constructor(){this.#t()}labels(...t){return this.#e({type:"metadata",data:{labels:t}})}links(...t){return this.#e({type:"metadata",data:{links:t}})}parameter(t,r,s){return this.#e({type:"metadata",data:{parameters:[{name:t,value:r,...s}]}})}description(t){return this.#e({type:"metadata",data:{description:t}})}descriptionHtml(t){return this.#e({type:"metadata",data:{descriptionHtml:t}})}displayName(t){return this.#e({type:"metadata",data:{displayName:t}})}historyId(t){return this.#e({type:"metadata",data:{historyId:t}})}testCaseId(t){return this.#e({type:"metadata",data:{testCaseId:t}})}attachment(t,r,s){let n=r?.type==="Buffer"?r.data:r,a=typeof n=="string"?"utf8":"base64",o=oe(n);return this.#e({type:"attachment_content",data:{name:t,content:o,encoding:a,contentType:s.contentType,fileExtension:s.fileExtension}})}attachmentFromPath(t,r,s){return this.#e({type:"attachment_path",data:{name:t,path:r,contentType:s.contentType,fileExtension:s.fileExtension}})}logStep(t,r=u.PASSED,s){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve())).then(()=>this.#e({type:"step_stop",data:{status:r,stop:Date.now(),statusDetails:s?{...S(s)}:void 0}}))}step(t,r){return cy.wrap(_,{log:!1}).then(()=>(this.#e({type:"step_start",data:{name:t,start:Date.now()}}),Cypress.Promise.resolve(r()))).then(s=>this.#e({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}}).then(()=>s))}stepDisplayName(t){return this.#e({type:"step_metadata",data:{name:t}})}stepParameter(t,r,s){return this.#e({type:"step_metadata",data:{parameters:[{name:t,value:r,mode:s}]}})}flushAllureMessagesToTask=t=>{let r=this.#r();r.length&&cy.task(t,{absolutePath:Cypress.spec.absolute,messages:r},{log:!1})};flushAllureMessagesToTaskAsync=t=>{let r=this.#r();if(r.length){let s={absolutePath:Cypress.spec.absolute,messages:r,isInteractive:Cypress.config("isInteractive")};return cy.task(t,s,{log:!1})}};#t=()=>ve([]);#e=t=>(c(t),Cypress.Promise.resolve());#r=()=>{let t=b();return this.#t(),t}},be=()=>j(new W),Me=()=>U(),Re=()=>{c({type:"cypress_run_start",data:{}})},Pe=e=>{c({type:"cypress_suite_start",data:{id:e.id,name:e.title,root:e.root,start:Date.now()}})},De=e=>{c({type:"cypress_suite_end",data:{root:e.root,stop:Date.now()}})},Y=(e,t)=>{c({type:"cypress_hook_start",data:{name:e.title,scopeType:e.hookName.includes("each")?"each":"all",position:e.hookName.includes("before")?"before":"after",start:t??Date.now()}})},k=e=>{c({type:"cypress_hook_end",data:{duration:e.duration??0}})},q=e=>{Ce(e),c({type:"cypress_test_start",data:K(e)}),$(e)},Z=(e,t)=>{let r=b();O(r).forEach(()=>{c({type:"step_stop",data:{stop:Date.now(),status:e,statusDetails:t}})})},ke=()=>{Z(u.PASSED),c({type:"cypress_test_pass",data:{}})},we=e=>{A(e)?He(u.SKIPPED,{message:"The test was skipped before the command was completed"}):q(e),c({type:"cypress_test_skip",data:z()})},Ie=e=>{let{stepsFromCommands:{maxArgumentDepth:t,maxArgumentLength:r}}=Ee();c({type:"cypress_command_start",data:{name:`Command "${e.attributes.name}"`,args:e.attributes.args.map(s=>H(s,{maxDepth:t,maxLength:r})),start:Date.now()}})},Fe=()=>{c({type:"cypress_command_end",data:{status:u.PASSED,stop:Date.now()}})},Oe=(e,t)=>{c({type:"attachment_path",data:{path:e,name:t||"Screenshot",contentType:w.PNG}})},He=(e,t)=>{let r=b(),s=r.toReversed().findIndex(({type:i})=>i==="cypress_command_start"),n=r.toReversed().findIndex(({type:i})=>i==="cypress_command_end"),a=s>n,o={status:e,stop:Date.now()};t&&(o.statusDetails=t),a&&c({type:"cypress_command_end",data:o})},J=e=>{let t=v(e),r=S(e);He(t,r),c({type:"cypress_fail",data:{status:t,statusDetails:r}})},X=e=>{c({type:"cypress_test_end",data:{duration:e.duration??0,retries:e._retries??0}}),xe()},Q=(e,t)=>{let r=e.hookName.includes("each"),s=e.parent,n=Ot(e.title,r,t,s);k(e),wt(),It(s,n)},Ne=()=>{let[e,t,r]=jt();Lt(t,r),Ut(e)},ee=()=>Me().flushAllureMessagesToTask("reportAllureCypressSpecMessages"),Le=()=>Me().flushAllureMessagesToTaskAsync("reportFinalAllureCypressSpecMessages"),M=e=>{if(Kt(e)){let t=e.test;return C(t)||k(t),Le()}},je=(e,t)=>{try{return J(t),Q(e.test,t),Le()}catch(r){Vt(e,r)}},wt=()=>{let e=Te();e&&X(e)},It=(e,t)=>{for(let r of me(e))A(r)||Ft(r,r.pending?{...z(),status:u.SKIPPED}:t)},Ft=(e,t)=>{c({type:"cypress_skipped_test",data:{...K(e),...t,...ue(e),suites:ie(e).map(r=>r.id)}}),$(e)},Ot=(e,t,r,s)=>{let n=t?u.SKIPPED:v(r),{message:a,trace:o}=S(r);return{status:n,statusDetails:{message:t?Ht(e,s):a,trace:o}}},Ht=(e,t)=>{let r=t.title?`'${t.title}'`:"root";return`'${e}' defined in the ${r} suite has failed`},Nt=(e,...t)=>{let[r,s,n]=t;return typeof n>"u"&&typeof s>"u"?e(r):typeof s=="function"?e(r,s):e(r,s,n)},Lt=(e,t)=>{let r=a=>(o,i,p)=>{e();try{return Nt(a,o,i,p)}finally{t()}},s=globalThis.describe,n=r(s);n.only=r(s.only),n.skip=r(s.skip),globalThis.describe=n},jt=()=>{let e=0;return[()=>e,()=>{e++},()=>{e--}]},Ut=e=>{let t=globalThis.after,r=(s,n)=>typeof s=="string"?t(s,_e(e,n)):t(_e(e,s));globalThis.after=r},_e=(e,t)=>{if(e()===0&&t){let r=t.length?Gt(t):Bt(t);return Object.defineProperty(r,"name",{value:t.name}),r}return t},Gt=e=>function(t){let r=s=>{if(s){je(this,s)?.then(()=>t(s))||t(s);return}try{if(M(this)?.then(()=>t()))return}catch(n){t(n);return}t()};return e.bind(this)(r)},Bt=e=>function(){let t,r;try{t=e.bind(this)()}catch(s){r=s}if(r)Ae(this,r);else return x(t)?t.then(()=>M(this),s=>Ae(this,s)):(M(this),t)},Ae=(e,t)=>{if(!je(e,t)?.then(()=>{throw t}))throw t},Vt=(e,t)=>{try{console.error(`Unexpected error when reporting the failure of ${e.test?.title??"'after all'"}`),console.error(t)}catch{}},Kt=e=>{let t=e.test;return e.test.parent.hooks.findLast(a=>a.hookName==="after all")?.hookId===t.hookId};var{EVENT_RUN_BEGIN:zt,EVENT_SUITE_BEGIN:$t,EVENT_SUITE_END:Wt,EVENT_HOOK_BEGIN:Yt,EVENT_HOOK_END:qt,EVENT_TEST_BEGIN:Zt,EVENT_TEST_PASS:Jt,EVENT_TEST_FAIL:Xt,EVENT_TEST_PENDING:Qt,EVENT_TEST_END:er}=Mocha.Runner.constants,tr=()=>{he()||(Se(),Cypress.mocha.getRunner().on(zt,()=>{be(),Re()}).on($t,e=>{e.root&&le(Cypress.spec,e),Pe(e)}).on(Wt,e=>{De(e)}).on(Yt,e=>{C(e)||Y(e)}).on(qt,e=>{C(e)||k(e)}).on(Zt,e=>{A(e)||q(e)}).on(Jt,()=>{ke()}).on(Xt,(e,t)=>{let r="hookName"in e;if(r&&ye(e))return;r&&C(e)&&Y(e,Date.now()-(e.duration??0)),J(t),r&&Q(e,t)}).on(Qt,e=>{we(e)}).on(er,e=>{X(e)}),Cypress.Screenshot.defaults({onAfterScreenshot:(e,{path:t,name:r})=>{Oe(t,r)}}),Cypress.on("fail",e=>{let t=v(e),r=S(e);throw Z(t,r),e}),Cypress.on("command:start",e=>{V(e)||Ie(e)}),Cypress.on("command:end",e=>{V(e)||Fe()}),afterEach(E,ee),after(E,function(){ee(),M(this)}),Ne())};tr();export{w as ContentType,l as LabelName,R as LinkType,Ve as Severity,Be as Stage,u as Status,Ge as StatusByPriority,yt as allureId,it as attachment,pt as attachmentPath,rt as description,st as descriptionHtml,nt as displayName,gt as epic,ft as feature,at as historyId,dt as issue,y as label,Qe as labels,Et as layer,B as link,et as links,lt as logStep,Ct as owner,tt as parameter,vt as parentSuite,xt as severity,ct as step,ht as story,Tt as subSuite,St as suite,_t as tag,At as tags,ot as testCaseId,mt as tms};
//# sourceMappingURL=index.js.map
